<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <script>
    let mediaRecorder;
    let chunks = [];
    let spacePressed = false;

    // スペースキーが押されたときに録音開始
    document.addEventListener('keydown', async (e) => {
      // e.code === 'Space' でスペースキーを判定
      if (e.code === 'Space' && !spacePressed) {
        spacePressed = true;
        chunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            chunks.push(event.data);
          }
        };
      }
    });

    // スペースキーが離されたときに録音停止 → 音声を Base64 文字列化して Streamlit に返す
    document.addEventListener('keyup', (e) => {
      if (e.code === 'Space' && spacePressed) {
        spacePressed = false;
        mediaRecorder.stop();
        mediaRecorder.onstop = (event) => {
          const blob = new Blob(chunks, { type: 'audio/wav; codecs=0' });
          const reader = new FileReader();

          reader.onloadend = () => {
            const base64Audio = reader.result.split(',')[1];
            // Streamlit に値を返す
            window.parent.postMessage(
              {
                isStreamlitMessage: true,
                type: 'fromAudioRecorder',
                base64Audio: base64Audio
              },
              '*'
            );
          };
          reader.readAsDataURL(blob);
        };
      }
    });
  </script>
</head>
<body>
  <h3>スペースキーを押して録音 → 離して送信</h3>
  <p>押している間ずっと録音し，離すと音声を送信します．</p>
</body>
</html>
